<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Piñata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
--pink:#ff4fa6;
--yellow:#ffd84d;
--bg:#0f0f13;
--card:#1b1b22;
--muted:#9c9c9c;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Montserrat',sans-serif;
}

body{
background:var(--bg);
color:white;
padding:30px 15px;
display:flex;
justify-content:center;
}

.container{
width:100%;
max-width:900px;
}

h1{
text-align:center;
font-weight:800;
margin-bottom:25px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.card{
background:var(--card);
padding:20px;
border-radius:20px;
margin-bottom:20px;
text-align:center;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}

button{
margin-top:8px;
margin-right:6px;
padding:8px 16px;
border-radius:30px;
border:none;
font-weight:600;
cursor:pointer;
background:linear-gradient(135deg,var(--pink),var(--yellow));
color:#000;
}

.delete{
background:#ff3b3b;
color:white;
}

input, select{
width:100%;
margin-top:10px;
padding:8px;
border-radius:12px;
border:none;
text-align:center;
}

.ticketBox{
margin-top:10px;
background:#111;
padding:10px;
border-radius:12px;
font-size:13px;
}

/* POPUP */
.popup{
position:fixed;
inset:0;
background:rgba(0,0,0,.8);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
}

.popup.active{
display:flex;
}

.popup-card{
background:#1a1a2e;
width:90%;
max-width:600px;
padding:30px;
border-radius:20px;
overflow:auto;
max-height:90vh;
}

.popup-card h2{
margin-bottom:15px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.close-btn{
background:none;
color:white;
border:none;
font-size:22px;
cursor:pointer;
float:right;
}
</style>
</head>

<body>

<div class="container">
<h1>Panel Cotizaciones</h1>
<div id="lista"></div>
</div>

<div class="popup" id="popup">
<div class="popup-card">
<button class="close-btn" onclick="closePopup()">×</button>
<h2 id="popupTitle"></h2>
<div id="popupContent"></div>
</div>
</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbzrUJuNsIxO47dL4p3-JZjXL4gR8GneQmRJczlZ1TmaaRTtnDkwsH7Ln7h5dsQQ5fKs/exec";

let cotizaciones=[];
let tickets=[];

async function cargar(){
try{
const res=await fetch(`${API_URL}?action=getAll`);
const data=await res.json();
cotizaciones=data.cotizaciones||[];
tickets=data.tickets||[];
render();
}catch(e){
document.body.innerHTML="<h2 style='text-align:center'>Error conectando con API</h2>";
}
}

function render(){
const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones.forEach(c=>{

const relacionados=tickets.filter(t=>t.Folio===c.Folio);

const card=document.createElement("div");
card.className="card";

card.innerHTML=`
<h3>${c.Folio}</h3>
<p>${c.Cliente}</p>

<select onchange="updateEstatus(${c.rowIndex},this.value)">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobadas"?"selected":""}>Aprobadas</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<input type="number"
placeholder="Precio"
value="${c.Precio||""}"
onchange="guardarPrecio(${c.rowIndex},this.value)">

<button onclick="crearTicket('${c.Folio}')">Nuevo Ticket</button>
<button onclick="verCotizacion('${c.Folio}')">Ver Cotización</button>
<button onclick="verTickets('${c.Folio}')">Ver Tickets</button>

${relacionados.map((t,i)=>`
<div class="ticketBox">
Ticket ${String.fromCharCode(65+i)} —
Anticipo: ${t.Anticipo} —
Saldo pendiente: ${t["Saldo pendiente"]}
</div>
`).join("")}

<button class="delete" onclick="eliminar('${c.Folio}')">Eliminar</button>
`;

lista.appendChild(card);

});
}

async function updateEstatus(rowIndex,estatus){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Estatus:estatus
})
});
cargar();
}

async function guardarPrecio(rowIndex,precio){

const cot=cotizaciones.find(c=>c.rowIndex===rowIndex);
if(cot) cot.Precio=precio;

await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Precio:precio
})
});
}

async function crearTicket(folio){

const c=cotizaciones.find(x=>x.Folio===folio);

if(!c || Number(c.Precio)<=0){
alert("Define precio válido primero");
return;
}

const relacionados=tickets.filter(t=>t.Folio===folio);

if(relacionados.length===0){
let anticipo=Number(prompt("Monto anticipo (0 si es pago completo):"));
if(isNaN(anticipo)) return;
await guardarTicket(c,anticipo,c.Precio);
}else{
const saldo=Number(relacionados[0]["Saldo pendiente"]);
if(saldo<=0){
alert("Ya está liquidado");
return;
}
await guardarTicket(c,saldo,saldo);
}

cargar();
}

async function guardarTicket(c,anticipo,precio){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"saveTicket",
...c,
Anticipo:Number(anticipo),
Precio:Number(precio)
})
});
}

function verCotizacion(folio){

const c = cotizaciones.find(x => x.Folio === folio);
if(!c) return;

const html = `
<p><strong>Folio:</strong> ${c.Folio}</p>
<p><strong>Fecha de solicitud:</strong> ${c["Fecha de solicitud"] || "-"}</p>
<p><strong>Cliente:</strong> ${c.Cliente || "-"}</p>
<p><strong>Tamaño:</strong> ${c.Tamaño || "-"}</p>
<p><strong>Diseño:</strong> ${c.Diseño || "-"}</p>
<p><strong>Fecha de entrega:</strong> ${c["Fecha de entrega"] || "-"}</p>
<p><strong>Evento:</strong> ${c.Evento || "-"}</p>
<p><strong>Teléfono:</strong> ${c["Teléfono"] || "-"}</p>
<p><strong>Método de pago:</strong> ${c["Método de pago"] || "-"}</p>
<p><strong>Entrega:</strong> ${c.Entrega || "-"}</p>
<hr>
<p><strong>Precio:</strong> $${c.Precio || 0}</p>
<p><strong>Estatus:</strong> ${c.Estatus}</p>
`;

openPopup("Cotización " + folio, html);
}

function verTickets(folio){

const relacionados = tickets.filter(t => t.Folio === folio);

if(relacionados.length === 0){
openPopup("Tickets " + folio, "<p>Sin tickets generados</p>");
return;
}

const html = relacionados.map((t,i)=>{

return `
<div style="margin-bottom:20px;padding:15px;background:#111;border-radius:15px;">
<h3 style="margin-bottom:10px;">Ticket ${String.fromCharCode(65+i)}</h3>

<p><strong>Folio:</strong> ${t.Folio}</p>
<p><strong>Cliente:</strong> ${t.Cliente}</p>
<p><strong>Tamaño:</strong> ${t.Tamaño}</p>
<p><strong>Diseño:</strong> ${t.Diseño}</p>
<p><strong>Fecha de entrega:</strong> ${t["Fecha de entrega"]}</p>
<p><strong>Evento:</strong> ${t.Evento}</p>
<p><strong>Teléfono:</strong> ${t["Teléfono"]}</p>
<p><strong>Método de pago:</strong> ${t["Método de pago"]}</p>
<p><strong>Entrega:</strong> ${t.Entrega}</p>

<hr>

<p><strong>Precio del ticket:</strong> $${t.Precio}</p>
<p><strong>Anticipo:</strong> $${t.Anticipo}</p>
<p><strong>Saldo pendiente:</strong> $${t["Saldo pendiente"]}</p>

</div>
`;

}).join("");

openPopup("Tickets " + folio, html);
}

function openPopup(title,content){
document.getElementById("popupTitle").innerText=title;
document.getElementById("popupContent").innerHTML=content;
document.getElementById("popup").classList.add("active");
}

function closePopup(){
document.getElementById("popup").classList.remove("active");
}

async function eliminar(folio){
if(!confirm("Eliminar cotización y tickets?"))return;
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"deleteCotizacion",
folio
})
});
cargar();
}

cargar();

</script>

</body>
</html>
